# ä»£ç : ç½‘ç»œé€šä¿¡æ¡ˆä¾‹

## ç®€ä»‹:

ä¸€.ä½¿ç”¨NIOå®Œæˆç½‘ç»œé€šä¿¡çš„ä¸‰ä¸ªæ ¸å¿ƒ:

1.  é€šé“(Channel): è´Ÿè´£è¿æ¥

    â€‹    java.nio.channels.Channelæ¥å£

    â€‹      |-- SelectableChannel ğŸ‘‡é€‰æ‹©å™¨ç”¨äºç›‘æ§ä¸‹åˆ—Channel

    â€‹        |-- SocketChannel

    â€‹        |-- ServerSocketChannel

    â€‹        |-- DataGramChannel

    

    â€‹        |-- Pipe.SinkChannel

    â€‹        |-- Pipe.SourceChannel

 

2.  ç¼“å†²åŒº(Buffer): è´Ÿè´£æ•°æ®çš„å­˜å–

3.  é€‰æ‹©å™¨(Selector): æ˜¯SelectableChannelçš„å¤šè·¯å¤ç”¨å™¨,ç”¨äºç›‘æ§SelectableChannelçš„IOçŠ¶å†µ



## é˜»å¡å¼

#### å®¢æˆ·ç«¯

```java
public void client() throws IOException {

    // è·å–åœ°å€ä¿¡æ¯
    InetSocketAddress isa = new InetSocketAddress("127.0.0.1", 9898);

    // 1.è·å–ç½‘ç»œé€šé“
    SocketChannel sChannel = SocketChannel.open(isa);

    // 2.åˆ†é…æŒ‡å®šå¤§å°çš„ç¼“å†²åŒº
    ByteBuffer buf = ByteBuffer.allocate(1024);

    // 3.å»ºç«‹é€šé“,è¯»å–æœ¬åœ°æ•°æ®
    FileChannel open = FileChannel.open(Paths.get("IOTest\\1.jpg"), StandardOpenOption.READ);

    while (open.read(buf) != -1) {
        buf.flip();
        sChannel.write(buf);
        buf.clear();
    }

    // 4.å…³é—­ä¼ è¾“:å‘Šè¯‰æœåŠ¡ç«¯æˆ‘å·²ç»å‘å®Œäº†,ä½ å¯ä»¥ç»™æˆ‘åé¦ˆäº†
    sChannel.shutdownOutput();

    // 5. æ¥æ”¶æœåŠ¡å™¨çš„åé¦ˆ
    int len = 0;
    while( (len = sChannel.read(buf)) !=-1){
        buf.flip();
        System.out.println(new String(buf.array(),0,len));
        buf.clear();
    }

    // 6.å…³é—­é€šé“
    open.close();
    sChannel.close();
}
```

#### æœåŠ¡å™¨ç«¯

```java
public void Server() throws IOException {

    // è·å–åœ°å€ä¿¡æ¯
    InetSocketAddress isa = new InetSocketAddress(9898);

    // 1.è·å–ç½‘ç»œé€šé“
    ServerSocketChannel ssChannel = ServerSocketChannel.open();

    // 2.ç»‘å®šé“¾æ¥
    ssChannel.bind(isa);

    // 3.è·å–å®¢æˆ·ç«¯è¿æ¥çš„é€šé“
    SocketChannel sChannel = ssChannel.accept();

    // 4.åˆ†é…ç¼“å†²åŒº
    ByteBuffer buf = ByteBuffer.allocate(1024);

    // 5.å»ºç«‹æœ¬åœ°æ–‡ä»¶é€šé“,å¹¶æ¥æ”¶å®¢æˆ·ç«¯æ•°æ®,é€šè¿‡é€šé“ä¿å­˜åˆ°æœ¬åœ°
    FileChannel outChannel = FileChannel.open(Paths.get("IOTest\\accept.jpg"),StandardOpenOption.CREATE,StandardOpenOption.WRITE);

    while(sChannel.read(buf) != -1){
        buf.flip();
        outChannel.write(buf);
        buf.clear();
    }

    // 6.åé¦ˆç»™å®¢æˆ·ç«¯
    buf.put("æ¥æ”¶å®Œæˆ".getBytes());
    buf.flip();
    sChannel.write(buf);

    // 7.å…³é—­é€šé“
    sChannel.close();
    ssChannel.close();
    outChannel.close();
}
```



## **éé˜»å¡å¼**

#### å®¢æˆ·ç«¯

```java
@Test
public void client() throws IOException {

    // 1.è·å–é€šé“
    SocketChannel sChannel = SocketChannel.open((new InetSocketAddress("127.0.0.1", 9898)));

    // 2.åˆ‡æ¢åˆ°éé˜»å¡æ¨¡å¼
    sChannel.configureBlocking(false);

    // 3.åˆ†é…æŒ‡å®šå¤§å°çš„ç¼“å†²åŒº
    ByteBuffer buf = ByteBuffer.allocate(100);

    Scanner sc = new Scanner(System.in);
    String temp = "";
    while (true) {
        System.out.print("è¯·è¾“å…¥æ¶ˆæ¯: ");
        temp = sc.nextLine();

        // 4.ç¼“å†²åŒºè·å–æ•°æ®
        buf.put(temp.getBytes());
        if ("exit".equalsIgnoreCase(temp)) {
            break;
        }

        // 5.å‘é€æ•°æ®ç»™æœåŠ¡ç«¯
        buf.flip();
        sChannel.write(buf);
        buf.clear();
    }

    // 5.å…³é—­é€šé“
    sChannel.close();
}
```

#### æœåŠ¡å™¨ç«¯

```java
@Test

public void server() throws IOException{

    //1. è·å–é€šé“
    ServerSocketChannel ssChannel = ServerSocketChannel.open();

    //2. åˆ‡æ¢éé˜»å¡æ¨¡å¼
    ssChannel.configureBlocking(false);

    //3. ç»‘å®šè¿æ¥
    ssChannel.bind(new InetSocketAddress(9898));

    //4. è·å–é€‰æ‹©å™¨
    Selector selector = Selector.open();

    //5. å°†é€šé“æ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸Š, å¹¶ä¸”æŒ‡å®šâ€œç›‘å¬æ¥æ”¶äº‹ä»¶â€
    ssChannel.register(selector, SelectionKey.OP_ACCEPT);

    //6. è½®è¯¢å¼çš„è·å–é€‰æ‹©å™¨ä¸Šå·²ç»â€œå‡†å¤‡å°±ç»ªâ€çš„äº‹ä»¶
    while(selector.select() > 0){

        //7. è·å–å½“å‰é€‰æ‹©å™¨ä¸­æ‰€æœ‰æ³¨å†Œçš„â€œé€‰æ‹©é”®(å·²å°±ç»ªçš„ç›‘å¬äº‹ä»¶)â€
        Iterator<SelectionKey> it = selector.selectedKeys().iterator();

        while(it.hasNext()){

            //8. è·å–å‡†å¤‡â€œå°±ç»ªâ€çš„æ˜¯äº‹ä»¶
            SelectionKey sk = it.next();

            //9. åˆ¤æ–­å…·ä½“æ˜¯ä»€ä¹ˆäº‹ä»¶å‡†å¤‡å°±ç»ª
            if(sk.isAcceptable()){

                //10. è‹¥â€œæ¥æ”¶å°±ç»ªâ€ï¼Œè·å–å®¢æˆ·ç«¯è¿æ¥
                SocketChannel sChannel = ssChannel.accept();

                //11. åˆ‡æ¢éé˜»å¡æ¨¡å¼
                sChannel.configureBlocking(false);

                //12. å°†è¯¥é€šé“æ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸Š
                sChannel.register(selector, SelectionKey.OP_READ);
            }else if(sk.isReadable()){

                //13. è·å–å½“å‰é€‰æ‹©å™¨ä¸Šâ€œè¯»å°±ç»ªâ€çŠ¶æ€çš„é€šé“
                SocketChannel sChannel = (SocketChannel) sk.channel();

                //14. è¯»å–æ•°æ®
                ByteBuffer buf = ByteBuffer.allocate(100);
                int len = 0;

                while((len = sChannel.read(buf)) > 0 ){ // readçš„è¿”å›å€¼æ˜¯positionçš„ä½ç½®
                    System.out.println("-------åŸå§‹æ•°æ®-------");
                    System.out.println("Capacity: "+buf.capacity());
                    System.out.println("Limit: "+buf.limit());
                    System.out.println("Position: "+buf.position());
                    System.out.println("len = "+len);

                    buf.flip();
                    System.out.println("-------flipä¹‹å-------");
                    System.out.println("Capacity: "+buf.capacity());
                    System.out.println("Limit: "+buf.limit());
                    System.out.println("Position: "+buf.position());
                    System.out.println("len = "+len);
                    System.out.println(new String(buf.array(), 0, len));
                    buf.clear();
                }
            }

            //15. å–æ¶ˆé€‰æ‹©é”® SelectionKey
            it.remove();
        }
    }
}
```
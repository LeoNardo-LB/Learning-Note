# DBUtils工具包

commons-dbutils 是 Apache 组织提供的一个开源 JDBC工具类库，它是对JDBC的简单封装，学习成本极低，并且使用dbutils能极大简化jdbc编码的工作量，同时也不会影响程序的性能。

其中QueryRunner类封装了SQL的执行，是线程安全的。

（1）可以实现增、删、改、查、批处理、

（2）考虑了事务处理需要共用Connection。

（3）该类最主要的就是简单化了SQL查询，它与ResultSetHandler组合在一起使用可以完成大部分的数据库操作，能够大大减少编码量。

**（1）更新**

public int update(Connection conn, String sql, Object... params) throws SQLException:用来执行一个更新（插入、更新或删除）操作。

......

**（2）插入**

public <T> T insert(Connection conn,String sql,ResultSetHandler<T> rsh, Object... params) throws SQLException：只支持INSERT语句，其中 rsh - The handler used to create the result object from the ResultSet of auto-generated keys.  返回值: An object generated by the handler.即自动生成的键值

....

**（3）批处理**

public int[] batch(Connection conn,String sql,Object[][] params)throws SQLException： INSERT, UPDATE, or DELETE语句

public <T> T insertBatch(Connection conn,String sql,ResultSetHandler<T> rsh,Object[][] params)throws SQLException：只支持INSERT语句

.....

**（4）使用QueryRunner类实现查询**

public Object query(Connection conn, String sql, ResultSetHandler rsh,Object... params) throws SQLException：执行一个查询操作，在这个查询中，对象数组中的每个元素值被用来作为查询语句的置换参数。该方法会自行处理 PreparedStatement 和 ResultSet 的创建和关闭。

....

***ResultSetHandler***接口用于处理 java.sql.ResultSet，将数据按要求转换为另一种形式。ResultSetHandler 接口提供了一个单独的方法：Object handle (java.sql.ResultSet  rs)该方法的返回值将作为QueryRunner类的query()方法的返回值。

**该接口有如下实现类可以使用：**

* BeanHandler：将结果集中的第一行数据封装到一个对应的JavaBean实例中。
* BeanListHandler：将结果集中的每一行数据都封装到一个对应的JavaBean实例中，存放到List里。
* ScalarHandler：查询单个值对象
* MapHandler：将结果集中的第一行数据封装到一个Map里，key是列名，value就是对应的值。
* MapListHandler：将结果集中的每一行数据都封装到一个Map里，然后再存放到List
* ColumnListHandler：将结果集中某一列的数据存放到List中。
* KeyedHandler(name)：将结果集中的每一行数据都封装到一个Map里，再把这些map再存到一个map里，其key为指定的key。
* ArrayHandler：把结果集中的第一行数据转成对象数组。
* ArrayListHandler：把结果集中的每一行数据都转成一个数组，再存放到List中。

#### DBUtils工具包的使用

1.  导入jar包

![image.png](_images/1599124603296-8363da9b-e96c-40e2-87f3-134da88126c8.png)

2.  编写代码

    

## 编写代码

##### 使用现成的jar中的QueryRunner测试增、删、改的操作:

```java
//测试插入
@Test
public void testInsert() {
    Connection conn = null;
    try {
        QueryRunner runner = new QueryRunner();
        conn = JdbcUtils.getConnection3();
        String sql = "insert into customers(name,email,birth)values(?,?,?)";
        int insertCount = runner.update(conn, sql, "蔡徐坤","caixukun@126.com","1997-09-08");
        System.out.println("添加了" + insertCount + "条记录");
    } catch (SQLException e) {
        e.printStackTrace();
    }finally{
        JdbcUtils.closeResource(conn, null);
    }

}
```

##### 使用现成的jar中的QueryRunner测试查询的操作:

```java
//测试查询
/*
     * BeanHander:是ResultSetHandler接口的实现类，用于封装表中的一条记录。
     */
@Test
public void testQuery1(){
    Connection conn = null;
    try {
        QueryRunner runner = new QueryRunner();
        conn = JdbcUtils.getConnection3();
        String sql = "select id,name,email,birth from customers where id = ?";
        BeanHandler<Customer> handler = new BeanHandler<>(Customer.class);
        Customer customer = runner.query(conn, sql, handler, 23);
        System.out.println(customer);
    } catch (SQLException e) {
        // TODO Auto-generated catch block
        e.printStackTrace();
    }finally{
        JdbcUtils.closeResource(conn, null);

    }

}

/*
     * BeanListHandler:是ResultSetHandler接口的实现类，用于封装表中的多条记录构成的集合。
     */
@Test
public void testQuery2() {
    Connection conn = null;
    try {
        QueryRunner runner = new QueryRunner();
        conn = JdbcUtils.getConnection3();
        String sql = "select id,name,email,birth from customers where id < ?";

        BeanListHandler<Customer>  handler = new BeanListHandler<>(Customer.class);

        List<Customer> list = runner.query(conn, sql, handler, 23);
        list.forEach(System.out::println);
    } catch (SQLException e) {
        e.printStackTrace();
    }finally{

        JdbcUtils.closeResource(conn, null);
    }

}

/*
     * MapHander:是ResultSetHandler接口的实现类，对应表中的一条记录。
     * 将字段及相应字段的值作为map中的key和value
     */
@Test
public void testQuery3(){
    Connection conn = null;
    try {
        QueryRunner runner = new QueryRunner();
        conn = JdbcUtils.getConnection3();
        String sql = "select id,name,email,birth from customers where id = ?";
        MapHandler handler = new MapHandler();
        Map<String, Object> map = runner.query(conn, sql, handler, 23);
        System.out.println(map);
    } catch (SQLException e) {
        e.printStackTrace();
    }finally{
        JdbcUtils.closeResource(conn, null);

    }

}

/*
     * MapListHander:是ResultSetHandler接口的实现类，对应表中的多条记录。
     * 将字段及相应字段的值作为map中的key和value。将这些map添加到List中
     */
@Test
public void testQuery4(){
    Connection conn = null;
    try {
        QueryRunner runner = new QueryRunner();
        conn = JdbcUtils.getConnection3();
        String sql = "select id,name,email,birth from customers where id < ?";

        MapListHandler handler = new MapListHandler();
        List<Map<String, Object>> list = runner.query(conn, sql, handler, 23);
        list.forEach(System.out::println);
    } catch (SQLException e) {
        e.printStackTrace();
    }finally{
        JdbcUtils.closeResource(conn, null);

    }

}

/*
     * ScalarHandler: ScalarHandler 的参数为空或null时，返回第一行第一列的数据 
     */
@Test
public void testQuery6(){
    Connection conn = null;
    try {
        QueryRunner runner = new QueryRunner();
        conn = JdbcUtils.getConnection3();

        String sql = "select max(birth) from customers";

        ScalarHandler handler = new ScalarHandler();
        Date maxBirth = (Date) runner.query(conn, sql, handler);
        System.out.println(maxBirth);
    } catch (SQLException e) {
        e.printStackTrace();
    }finally{
        JdbcUtils.closeResource(conn, null);

    }

}

/*
     * 自定义ResultSetHandler的实现类
     */
@Test
public void testQuery7(){
    Connection conn = null;
    try {
        QueryRunner runner = new QueryRunner();
        conn = JdbcUtils.getConnection3();

        String sql = "select id,name,email,birth from customers where id = ?";
        ResultSetHandler<Customer> handler = new ResultSetHandler<Customer>(){

            @Override
            public Customer handle(ResultSet rs) throws SQLException {
                //      System.out.println("handle");
                //      return null;
                //      return new Customer(12, "成龙", "Jacky@126.com", new Date(234324234324L));

                if(rs.next()){
                    int id = rs.getInt("id");
                    String name = rs.getString("name");
                    String email = rs.getString("email");
                    Date birth = rs.getDate("birth");
                    Customer customer = new Customer(id, name, email, birth);
                    return customer;
                }
                return null;

            }

        };
        Customer customer = runner.query(conn, sql, handler,23);
        System.out.println(customer);
    } catch (SQLException e) {
        e.printStackTrace();
    }finally{
        JdbcUtils.closeResource(conn, null);
    }
}
```

##### 使用dbutils.jar包中的DbUtils工具类实现连接等资源的关闭：

```java
/**
     * 
     * @Description 使用dbutils.jar中提供的DbUtils工具类，实现资源的关闭
     * @param conn
     * @param ps
     * @param rs
     */
public static void closeResource(Connection conn,Statement ps,ResultSet rs){
    //      try {
    //          DbUtils.close(conn);
    //      } catch (SQLException e) {
    //          e.printStackTrace();
    //      }
    //      try {
    //          DbUtils.close(ps);
    //      } catch (SQLException e) {
    //          e.printStackTrace();
    //      }
    //      try {
    //          DbUtils.close(rs);
    //      } catch (SQLException e) {
    //          e.printStackTrace();
    //      }

    DbUtils.closeQuietly(conn);
    DbUtils.closeQuietly(ps);
    DbUtils.closeQuietly(rs);
}
```



**自定义Handler:**

```java
ResultSetHandler<T> resultSetHandler = new ResultSetHandler<T>() {
    @Override
    public T handle(ResultSet resultSet) throws SQLException {
        // 自定义操作 // 
        return null;
    }
}
```